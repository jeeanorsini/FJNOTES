<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FJNOTES Pro - Sem Mapa Mental</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');

  * {
    box-sizing: border-box;
  }
  html, body {
    margin: 0; padding: 0;
    font-family: 'Montserrat', sans-serif;
    height: 100%;
    background-color: #121212;
    color: #FFC107;
    overflow-y: auto;
  }
  body.light {
    background-color: #fdf6e3;
    color: #b58900;
  }

  header {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    padding: 1rem 2rem;
    background-color: inherit;
    border-bottom: 2px solid currentColor;
    position: sticky;
    top: 0;
    z-index: 1000;
  }
  h1 {
    margin: 0; font-weight: 700; font-size: 1.8rem;
    user-select: text;
  }
  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  button {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    border: 2px solid currentColor;
    background: transparent;
    color: inherit;
    cursor: pointer;
    font-weight: 700;
    font-size: 0.95rem;
    transition: background-color 0.25s ease, color 0.25s ease;
    user-select: none;
  }
  button:hover:not(:disabled) {
    background-color: #ffc107;
    color: #121212;
  }
  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  #searchInput {
    padding: 0.4rem 0.8rem;
    border-radius: 12px;
    border: none;
    background-color: #222;
    color: #ffc107;
    font-size: 1rem;
    outline: none;
    min-width: 210px;
    transition: background-color 0.25s ease;
  }
  body.light #searchInput {
    background-color: #eee8d5;
    color: #b58900;
  }
  #searchInput::placeholder {
    color: #deb639;
  }
  #searchInput:focus {
    background-color: #ffc107dd;
    color: #121212;
  }
  main {
    display: flex;
    padding: 1rem 2rem;
    gap: 1rem;
    min-height: calc(90vh - 70px);
    box-sizing: border-box;
    overflow-y: auto;
  }
  /* Colunas */
  #telaPrincipal {
    flex: 1;
    display: flex;
    overflow-x: auto;
    gap: 1rem;
    background-color: var(--panel-bg);
    border-radius: 12px;
    padding: 1rem;
    max-height: 90vh;
    box-sizing: border-box;
  }
  body.dark #telaPrincipal {
    --panel-bg: #1e1e1e;
  }
  body.light #telaPrincipal {
    --panel-bg: #eee8d5;
    color: #b58900;
  }
  .coluna {
    flex-shrink: 0;
    width: 300px;
    background-color: var(--col-bg);
    border-radius: 12px;
    border: 2px solid currentColor;
    box-shadow: 0 0 12px #ffc10744 inset;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    max-height: 90vh;
    overflow-y: auto;
  }
  body.dark .coluna {
    --col-bg: #2a2a2a;
  }
  body.light .coluna {
    --col-bg: #f7f1db;
  }
  .coluna h2 {
    margin: 0 0 1rem 0;
    font-weight: 900;
    letter-spacing: 1px;
    font-size: 1.3rem;
    user-select: text;
  }
  .btn-primary {
    background-color: #ffc107;
    color: #121212;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 50px;
    cursor: pointer;
    font-weight: 900;
    font-size: 1rem;
    margin-bottom: 1rem;
    transition: background-color 0.3s ease;
  }
  .btn-primary:hover {
    background-color: #ffca28cc;
  }
  /* CartÃµes */
  .cartao {
    flex-shrink: 0;
    background-color: var(--card-bg);
    color: inherit;
    border-radius: 12px;
    box-shadow: 0 0 10px #ffc10755;
    padding: 0.75rem 1rem;
    margin-bottom: 0.75rem;
    cursor: grab;
    border: 1.5px solid currentColor;
    user-select: text;
    display: flex;
    flex-direction: column;
  }
  body.dark .cartao {
    --card-bg: #333;
  }
  body.light .cartao {
    --card-bg: #fff8dc;
  }
  .cartao textarea {
    all: unset;
    width: 100%;
    font-family: 'Montserrat', sans-serif;
    font-weight: 600;
    font-size: 1rem;
    white-space: pre-wrap;
    word-break: break-word;
    min-height: 40px;
    resize: vertical;
    color: inherit;
  }
  /* Modo mapa mental removido */

  /* Toast */
  #toast {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    background-color: #ffc107dd;
    color: #121212;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    font-weight: 700;
    font-family: 'Montserrat', sans-serif;
    box-shadow: 0 0 15px #ffc107aa;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    z-index: 9999;
  }
  #toast.show {
    opacity: 1;
    pointer-events: auto;
  }
</style>
</head>
<body class="">
<header>
  <h1>FJNOTES Pro</h1>
  <input type="search" id="searchInput" placeholder="Buscar cartÃµes ou tÃ³picos..." oninput="filtrarConteudo()" />
  <div class="controls">
    <button onclick="undoEstado()" id="btnUndo" disabled title="Desfazer (Ctrl+Z)">â†¶ Undo</button>
    <button onclick="redoEstado()" id="btnRedo" disabled title="Refazer (Ctrl+Y)">â†· Redo</button>
    <button onclick="toggleTema()" title="Alternar tema claro/escuro">ðŸŒ“ Tema</button>
  </div>
</header>

<main>
  <div id="telaPrincipal" aria-label="Quadro de colunas" role="region"></div>
</main>

<div id="botoesBarras" role="toolbar" style="margin:1rem; display:flex; gap:0.5rem; justify-content:center;">
  <button onclick="adicionarColuna()">Adicionar Coluna</button>
  <button onclick="mostrarTabuleiro()">Mostrar Quadro</button>
  <button onclick="exportarDados()">Exportar Dados</button>
  <button onclick="mostrarImportar()">Importar Dados</button>
  <button onclick="limparTudo()">Limpar Tudo</button>
</div>

<input type="file" id="arquivoImportar" style="display:none" onchange="importarDados(event)" />

<div id="toast"></div>

<script>
  // VariÃ¡veis principais
  let colunas = [];
  let modoMapa = false; // modo mapa mental removido, mas mantido por compatibilidade
  let selecao = [];

  let historico = [];
  let indexHistorico = -1;
  const MAX_HIST = 50;

  // FunÃ§Ã£o toast
  function toast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
  }

  function salvarEstado() {
    if(indexHistorico < historico.length -1) {
      historico.splice(indexHistorico+1);
    }
    const snapshot = JSON.stringify({colunas});
    historico.push(snapshot);
    if(historico.length > MAX_HIST) {
      historico.shift();
      if(indexHistorico>0)indexHistorico--;
    } else {
      indexHistorico++;
    }
    atualizarBotoesUndoRedo();
    salvarDadosLocal();
  }
  function desfazer() {
    if(indexHistorico > 0) {
      indexHistorico--;
      carregarEstadoHistorico();
    }
  }
  function refazer() {
    if(indexHistorico < historico.length-1) {
      indexHistorico++;
      carregarEstadoHistorico();
    }
  }
  function carregarEstadoHistorico() {
    try {
      const snap = historico[indexHistorico];
      if(snap) {
        const estado = JSON.parse(snap);
        colunas = estado.colunas || [];
        selecao = [];
        renderizarColunas();
        toast('AÃ§Ãµes restauradas');
        atualizarBotoesUndoRedo();
      }
    } catch {
      toast('Erro ao restaurar');
    }
  }
  function atualizarBotoesUndoRedo() {
    document.getElementById('btnUndo').disabled = indexHistorico <= 0;
    document.getElementById('btnRedo').disabled = indexHistorico >= historico.length-1 || indexHistorico<0;
  }
  function undoEstado() { desfazer(); }
  function redoEstado() { refazer(); }

  // Tema
  function toggleTema() {
    document.body.classList.toggle('dark');
    document.body.classList.toggle('light');
    localStorage.setItem('tema', document.body.classList.contains('dark') ? 'dark' : 'light');
  }
  function aplicarTemaSalvo() {
    const tema = localStorage.getItem('tema') || 'dark';
    document.body.classList.toggle('dark', tema==='dark');
    document.body.classList.toggle('light', tema==='light');
  }

  // PersistÃªncia local
  function salvarDadosLocal() {
    localStorage.setItem('dadosGerenciador', JSON.stringify({colunas}));
  }
  function carregarDadosLocal() {
    const dados = localStorage.getItem('dadosGerenciador');
    if(dados) {
      try {
        const obj = JSON.parse(dados);
        colunas = obj.colunas || [];
      } catch {
        colunas = [];
      }
    }
  }
  carregarDadosLocal();
  aplicarTemaSalvo();

  // ==== CRUD colunas ====
  function adicionarColuna() {
    let nome = prompt('Nome da nova coluna:', 'Nova coluna');
    if(!nome) return;
    colunas.push({ id: Date.now(), nome, cartoes: [] });
    salvarEstado();
    renderizarColunas();
  }

  function renderizarColunas() {
    const container = document.getElementById('telaPrincipal');
    container.innerHTML = '';
    colunas.forEach(col => {
      const colDiv = document.createElement('div');
      colDiv.className = 'coluna';
      colDiv.setAttribute('data-id', col.id);
      // TÃ­tulo
      const h2 = document.createElement('h2');
      h2.textContent = col.nome;
      colDiv.appendChild(h2);
      // BotÃ£o para adicionar cartÃ£o
      const btnAddCard = document.createElement('button');
      btnAddCard.className = 'btn-primary';
      btnAddCard.textContent = 'Adicionar CartÃ£o';
      btnAddCard.onclick = () => {
        const texto = prompt('ConteÃºdo do cartÃ£o:', '');
        if(!texto) return;
        col.cartoes.push({ id: Date.now(), texto, tags: [] });
        salvarEstado();
        renderizarColunas();
      };
      colDiv.appendChild(btnAddCard);
      // CartÃµes
      col.cartoes.forEach((cartao, i) => {
        const cartaoDiv = document.createElement('div');
        cartaoDiv.className = 'cartao';
        cartaoDiv.setAttribute('data-colid', col.id);
        cartaoDiv.setAttribute('data-index', i);
        cartaoDiv.draggable = true;
        cartaoDiv.ondragstart = e => {
          e.dataTransfer.setData('cartao', JSON.stringify({ colId: col.id, index: i }));
        };

        // Texto
        const ta = document.createElement('textarea');
        ta.value = cartao.texto;
        ta.oninput = () => {
          cartao.texto = ta.value;
          salvarEstado();
        };
        cartaoDiv.appendChild(ta);

        // Tags
        const tagsContainer = document.createElement('div');
        tagsContainer.className = 'tag-list';
        (cartao.tags || []).forEach(t => {
          const spanTag = document.createElement('span');
          spanTag.className = 'tag';
          spanTag.textContent = t;
          spanTag.title = 'Clique para remover tag';
          spanTag.onclick = () => {
            cartao.tags = cartao.tags.filter(tag => tag !== t);
            salvarEstado();
            renderizarColunas();
            toast(`Tag "${t}" removida`);
          };
          tagsContainer.appendChild(spanTag);
        });
        cartaoDiv.appendChild(tagsContainer);
        // BotÃ£o add tag
        const btnAddTag = document.createElement('button');
        btnAddTag.textContent = '+Tag';
        btnAddTag.title = 'Adicionar tag';
        btnAddTag.onclick = e => {
          e.stopPropagation();
          const novaTag = prompt('Nome da tag:');
          if(novaTag && !cartao.tags.includes(novaTag.trim())) {
            cartao.tags.push(novaTag.trim());
            salvarEstado();
            renderizarColunas();
            toast(`Tag "${novaTag.trim()}" adicionada`);
          }
        };
        cartaoDiv.appendChild(btnAddTag);
        // BotÃ£o excluir cartÃ£o
        const btnExcluir = document.createElement('button');
        btnExcluir.textContent = 'Ã—';
        btnExcluir.title = 'Excluir cartÃ£o';
        btnExcluir.onclick = e => {
          e.stopPropagation();
          if(confirm('Excluir este cartÃ£o?')) {
            col.cartoes.splice(i,1);
            salvarEstado();
            renderizarColunas();
          }
        };
        cartaoDiv.appendChild(btnExcluir);
        // Drag & Drop na coluna
        colDiv.ondragover = e => e.preventDefault();
        colDiv.ondrop = e => {
          const data = JSON.parse(e.dataTransfer.getData('cartao'));
          const origCol = colunas.find(c => c.id === data.colId);
          if(origCol) {
            const cartao = origCol.cartoes.splice(data.index,1)[0];
            col.cartoes.push(cartao);
            salvarEstado();
            renderizarColunas();
          }
        };
        // Adiciona cartÃ£o na coluna
        container.appendChild(colDiv);
        colDiv.appendChild(cartaoDiv);
      });
    });
  }

  // ==== FunÃ§Ãµes de controle de filtro, exportar/importar, limpar ====
  function filtrarConteudo() {
    const q = document.getElementById('searchInput').value.toLowerCase();
    // Colunas e cartÃµes
    document.querySelectorAll('#telaPrincipal > .coluna').forEach(colEl => {
      const colId = +colEl.getAttribute('data-id');
      const col = colunas.find(c => c.id===colId);
      const colMatch = col.nome.toLowerCase().includes(q);
      let hasVisivel = false;
      colEl.querySelectorAll('.cartao').forEach(cartEl => {
        const i = +cartEl.getAttribute('data-index');
        const cart = col.cartoes[i];
        const txt = cart.texto.toLowerCase();
        const tagsStr = (cart.tags ||[]).join(',').toLowerCase();
        const show = colMatch || txt.includes(q) || tagsStr.includes(q);
        cartEl.style.display = show ? '' : 'none';
        if(show) hasVisivel = true;
      });
      colEl.style.display = (colMatch || hasVisivel) ? '' : 'none';
    });
  }

  function exportarDados() {
    const dados = { colunas };
    const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'fjnotes-dados.json';
    a.click();
    URL.revokeObjectURL(url);
    toast('Dados exportados');
  }
  function mostrarImportar() {
    document.getElementById('arquivoImportar').click();
  }
  function importarDados(e) {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const dados = JSON.parse(reader.result);
        colunas = dados.colunas || [];
        salvarEstado();
        renderizarColunas();
        toast('Dados importados');
        mostrarTabuleiro();
      } catch {
        toast('Erro ao importar');
      }
    };
    reader.readAsText(file);
  }

  // Limpar tudo
  function limparTudo() {
    if(confirm('Deseja apagar tudo?')){
      colunas = [];
      salvarEstado();
      renderizarColunas();
    }
  }

  // Mostrar modo quadro
  function mostrarTabuleiro() {
    document.getElementById('telaPrincipal').style.display='flex';
  }
  // Inicializa
  renderizarColunas();
  mostrarTabuleiro();
  salvarEstado();

</script>
</body>
</html>
