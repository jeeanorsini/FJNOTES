<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FJNOTES Pro - Tarefas Avan√ßadas</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');
  * { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Montserrat', sans-serif;
  background-color: #121212;
  color: #FFC107;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  overflow-x: hidden;
}
body.light {
  background-color: #fdf6e3;
  color: #b58900;
}

/* Cabe√ßalho */
header {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  justify-content: space-between;
  padding: 1rem 2rem;
  position: sticky;
  top: 0;
  background-color: inherit;
  border-bottom: 2px solid currentColor;
  z-index: 999;
}
h1 { font-weight: 700; font-size: 1.8rem; margin-right: 1rem; }
#searchInput {
  padding: 0.4rem 0.8rem;
  border-radius: 12px;
  border: none;
  background-color: #222;
  color: #ffc107;
  font-size: 1rem;
  outline: none;
  min-width: 200px;
  margin: 0.5rem 0;
}
body.light #searchInput {
  background-color: #eee8d5;
  color: #b58900;
}
#searchInput::placeholder { color: #deb639; }

#botoes {
  display: flex;
  gap: 8px;
  margin-top: 0.5rem;
}

button {
  padding: 0.4rem 0.8rem;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 700;
  font-size: 0.85rem;
  transition: background 0.3s;
}
button:hover { opacity: 0.8; }

#toast {
  position: fixed; bottom: 1.5rem; right: 1.5rem;
  background: #ffc107dd; padding: 1rem; border-radius: 8px; font-weight: 700; font-family: 'Montserrat', sans-serif;
  box-shadow: 0 0 15px #ffc107aa; opacity: 0; transition: opacity 0.3s ease; z-index: 9999;
}
#toast.show { opacity: 1; }

/* √Årea principal */
main {
  flex: 1;
  padding: 1rem 2rem;
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  overflow-y: auto;
}

/* Cart√µes */
.cartao {
  background: #fff8dc;
  border-radius: 12px;
  padding: 1rem;
  width: 300px;
  display: flex;
  flex-direction: column;
  box-shadow: 0 0 10px #ffc10755;
  border: 2px solid currentColor;
  position: relative;
  transition: border-color 0.3s, box-shadow 0.3s;
}
.prioridade-alto { border-color: #d32f2f; }
.prioridade-medio { border-color: #fbc02d; }
.prioridade-baixo { border-color: #388e3c; }

.titulo {
  font-weight: 900; font-size: 1.2rem; margin-bottom: 0.5rem; cursor: text;
}
.titulo:focus { outline: 2px solid #ffc107; }

.progress-container {
  background: #ddd; height: 10px; border-radius: 5px; margin: 8px 0;
  width: 100%; overflow: hidden;
}
.progress-bar {
  height: 10px; background: #ffc107; width: 0%; border-radius: 5px;
  transition: width 0.5s ease;
}

.info {
  display: flex; justify-content: space-between; flex-wrap: wrap; font-size: 0.85rem; margin-top: 0.5rem;
}
.info div { margin: 4px 0; }

.comentarios {
  margin-top: 0.5rem; border-top: 1px solid #ccc; padding-top: 0.5rem;
}
.comentarios h4 { margin: 0 0 0.5rem 0; font-size: 1rem; }
.comentario {
  background: #fff; padding: 0.5rem; border-radius: 8px; margin-bottom: 0.5rem; font-size: 0.9rem;
}

.botoes-acao {
  display: flex; gap: 4px; margin-top: 0.5rem; flex-wrap: wrap;
}
button {
  padding: 0.4rem 0.8rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 0.75rem;
}
.btnExcluir { background: #d32f2f; color: #fff; }
.btnComentario { background: #1976d2; color: #fff; }
.btnSalvar { background: #388e3c; color: #fff; }

.prioridade-badge {
  padding: 0.2rem 0.5rem;
  border-radius: 8px;
  font-size: 0.75rem;
  font-weight: bold;
  color: #fff;
  display: inline-block;
  min-width: 50px;
  text-align: center;
}
.prio-alto { background-color: #d32f2f; }
.prio-medio { background-color: #fbc02d; color: #000; }
.prio-baixo { background-color: #388e3c; }

#alertaAtrasadas {
  position: fixed;
  top: 10px;
  right: 10px;
  background: #d32f2f;
  color: #fff;
  padding: 1rem;
  border-radius: 8px;
  font-weight: bold;
  display: none;
  cursor: pointer;
  z-index: 10000;
  box-shadow: 0 0 10px #d32f2f;
  transition: opacity 0.3s ease;
}
#alertaAtrasadas.show {
  display: block;
  opacity: 1;
}
</style>
</head>
<body>

<!-- Notifica√ß√£o de tarefas atrasadas -->
<div id="alertaAtrasadas"></div>

<header>
  <h1>FJNOTES Pro - Tarefas</h1>
  <input type="search" id="searchInput" placeholder="Buscar..." oninput="filtrarConteudo()" />
  <div id="botoes">
    <button onclick="undoEstado()" id="btnUndo" disabled title="Desfazer">‚Ü∂ Undo</button>
    <button onclick="redoEstado()" id="btnRedo" disabled title="Refazer">‚Ü∑ Redo</button>
    <button onclick="toggleTema()" title="Alternar tema">üåì Tema</button>
  </div>
</header>

<main id="tarefasContainer">
  <!-- Cart√µes ser√£o inseridos aqui dinamicamente -->
</main>

<div style="margin:1rem; text-align:center;">
  <button onclick="adicionarColuna()">Adicionar Lista</button>
  <button onclick="criarTarefa()">Nova Tarefa</button>
  <button onclick="limparTudo()">Limpar Tudo</button>
  <button onclick="mostrarAnalise()">Painel de An√°lise</button>
</div>

<!-- Painel de an√°lise oculto -->
<div id="painelAnalise" style="display:none; position:fixed; top:10%; left:10%; width:80%; height:80%; background:#fff; padding:1rem; overflow:auto; z-index:10000; border-radius:8px;">
  <h2>An√°lise de Tarefas</h2>
  <button style="float:right;" onclick="fecharAnalise()">Fechar</button>
  <div id="dashboard"></div>
</div>

<!-- Modal coment√°rios -->
<div id="modalComentario" style="display:none; position:fixed; top:20%; left:20%; width:60%; height:40%; background:#fff; padding:1rem; overflow:auto; z-index:10000; border-radius:8px;">
  <h3>Coment√°rios</h3>
  <div id="comentariosList"></div>
  <textarea id="novoComentario" style="width:100%; height:3rem; margin-top:0.5rem;" placeholder="Adicionar coment√°rio"></textarea>
  <button onclick="salvarComentario()">Salvar Coment√°rio</button>
  <button onclick="fecharComentario()">Fechar</button>
</div>

<script>
  let colunas = [];
  let historico = [];
  let indexHistorico = -1;
  const MAX_HIST = 50;
  let tarefaEmEdicao = null;
  let tarefaAtualComentando = null;

  // Fun√ß√£o de toast
  function toast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
  }

  // Carregar do localStorage
  function salvarEstado() {
    if (indexHistorico < historico.length -1) {
      historico.splice(indexHistorico+1);
    }
    const snap = JSON.stringify({ colunas });
    historico.push(snap);
    if (historico.length > MAX_HIST) {
      historico.shift();
      if (indexHistorico > 0) indexHistorico--;
    } else {
      indexHistorico++;
    }
    atualizarBotoesUndoRedo();
    salvarDadosLocal();
  }

  function carregarEstado() {
    if (indexHistorico >= 0 && indexHistorico < historico.length) {
      try {
        const snap = JSON.parse(historico[indexHistorico]);
        colunas = snap.colunas || [];
        renderizarTarefas();
        atualizarBotoesUndoRedo();
        atualizarDashboard();
      } catch {
        toast('Erro ao restaurar');
      }
    }
  }

  function undoEstado() {
    if (indexHistorico > 0) {
      indexHistorico--;
      carregarEstado();
    }
  }

  function redoEstado() {
    if (indexHistorico < historico.length - 1) {
      indexHistorico++;
      carregarEstado();
    }
  }

  function atualizarBotoesUndoRedo() {
    document.getElementById('btnUndo').disabled = indexHistorico <= 0;
    document.getElementById('btnRedo').disabled = indexHistorico >= historico.length -1;
  }

  // Tema
  function toggleTema() {
    document.body.classList.toggle('dark');
    document.body.classList.toggle('light');
    localStorage.setItem('tema', document.body.classList.contains('dark') ? 'dark' : 'light');
  }
  function aplicarTema() {
    const t = localStorage.getItem('tema') || 'dark';
    document.body.classList.toggle('dark', t==='dark');
    document.body.classList.toggle('light', t==='light');
  }

  // Persist√™ncia local
  function salvarDadosLocal() {
    localStorage.setItem('tarefasDados', JSON.stringify({ colunas }));
  }
  function carregarDadosLocal() {
    const dados = localStorage.getItem('tarefasDados');
    if (dados) {
      try {
        const obj = JSON.parse(dados);
        colunas = obj.colunas || [];
      } catch {
        colunas = [];
      }
    }
  }

  // Fun√ß√£o para criar nova lista
  function adicionarColuna() {
    const nome = prompt('Nome da lista:', 'Nova Lista');
    if (!nome) return;
    colunas.push({ id: Date.now(), nome, tarefas: [] });
    salvarEstado();
    renderizarTarefas();
  }

  // Criar nova tarefa
  function criarTarefa() {
    const listaID = prompt('ID da lista onde criar a tarefa (deixe vazio para lista padr√£o):');
    let lista = null;
    if (listaID) {
      lista = colunas.find(c => c.id == listaID);
      if (!lista) { alert('Lista n√£o encontrada'); return; }
    } else {
      if(colunas.length===0){ alert('Nenhuma lista criada'); return; }
      lista = colunas[0];
    }
    const texto = prompt('Descri√ß√£o da tarefa:', 'Nova tarefa');
    if (!texto) return;
    lista.tarefas.push({
      id: Date.now(),
      texto,
      prioridade: 'Baixo',
      responsavel: '',
      vencimento: '',
      progresso: 0,
      comentarios: []
    });
    salvarEstado();
    renderizarTarefas();
  }

  // Renderizar tarefas
  function renderizarTarefas() {
    const container = document.getElementById('tarefasContainer');
    container.innerHTML = '';

    colunas.forEach(c => {
      const colDiv = document.createElement('div');
      colDiv.className = 'coluna';

      const tituloCol = document.createElement('h2');
      tituloCol.textContent = c.nome;
      colDiv.appendChild(tituloCol);

      c.tarefas.forEach((t, i) => {
        const card = document.createElement('div');
        card.className = 'cartao';

        // Badge de prioridade
        let prioClass = '';
        if(t.prioridade==='Alto') prioClass='prio-alto';
        if(t.prioridade==='M√©dio') prioClass='prio-medio';
        if(t.prioridade==='Baixo') prioClass='prio-baixo';

        const badge = document.createElement('div');
        badge.className = 'prioridade-badge ' + prioClass;
        badge.textContent = t.prioridade;

        // T√≠tulo
        const tituloTarefa = document.createElement('div');
        tituloTarefa.className='titulo';
        tituloTarefa.contentEditable=true;
        tituloTarefa.textContent = t.texto;
        tituloTarefa.onblur= ()=> {
          t.texto = tituloTarefa.textContent;
          salvarEstado();
        };

        // Data vencimento
        const venc = document.createElement('div');
        venc.textContent = 'Vence: ' + (t.vencimento || '---');
        if(t.vencimento && new Date(t.vencimento) < new Date()){
          venc.style.color='red';
        }

        // Respons√°vel
        const respDiv = document.createElement('div');
        respDiv.textContent = 'Respons√°vel: ' + (t.responsavel || '---');

        // Progresso
        const progContainer = document.createElement('div');
        progContainer.className='progress-container';
        const progBar = document.createElement('div');
        progBar.className='progress-bar';
        progBar.style.width= t.progresso + '%';

        // Atualiza a barra de progresso
        setTimeout(()=>{ progBar.style.width = t.progresso + '%'; }, 50);

        progContainer.appendChild(progBar);

        // Bot√µes
        const botoes = document.createElement('div');
        botoes.className='botoes-acao';

        const btnProgresso = document.createElement('button');
        btnProgresso.textContent='Progresso';
        btnProgresso.title='Incrementar progresso em 10%';
        btnProgresso.onclick= ()=> {
          t.progresso = Math.min(t.progresso + 10, 100);
          salvarEstado();
          renderizarTarefas();
        };

        const btnPrioridade = document.createElement('button');
        btnPrioridade.textContent='Prioridade';
        btnPrioridade.title='Alterar prioridade';
        btnPrioridade.onclick= ()=> {
          if(t.prioridade==='Baixo') t.prioridade='M√©dio';
          else if(t.prioridade==='M√©dio') t.prioridade='Alto';
          else t.prioridade='Baixo';
          salvarEstado();
          renderizarTarefas();
        };

        const btnResponsavel = document.createElement('button');
        btnResponsavel.textContent='Respons√°vel';
        btnResponsavel.title='Alterar respons√°vel';
        btnResponsavel.onclick= ()=> {
          const respNovo = prompt('Respons√°vel:', t.responsavel);
          if(respNovo!==null) {
            t.responsavel=respNovo;
            salvarEstado();
            renderizarTarefas();
          }
        };

        const btnVencimento = document.createElement('button');
        btnVencimento.textContent='Vencimento';
        btnVencimento.title='Alterar data de vencimento';
        btnVencimento.onclick= ()=> {
          const dataNovo = prompt('Data (YYYY-MM-DD):', t.vencimento);
          if(dataNovo!==null) {
            t.vencimento = dataNovo;
            salvarEstado();
            renderizarTarefas();
          }
        };

        const btnComentarios = document.createElement('button');
        btnComentarios.className='btnComentario';
        btnComentarios.textContent='Coment√°rios';
        btnComentarios.title='Ver/Add coment√°rios';
        btnComentarios.onclick= ()=> {
          abrirComentarios(t);
        };

        const btnExcluir = document.createElement('button');
        btnExcluir.className='btnExcluir';
        btnExcluir.textContent='Excluir';
        btnExcluir.title='Remover tarefa';
        btnExcluir.onclick= ()=> {
          if(confirm('Excluir tarefa?')){
            c.tarefas.splice(i,1);
            salvarEstado();
            renderizarTarefas();
          }
        };

        // Montar bot√µes
        botoes.appendChild(btnProgresso);
        botoes.appendChild(btnPrioridade);
        botoes.appendChild(btnResponsavel);
        botoes.appendChild(btnVencimento);
        botoes.appendChild(btnComentarios);
        botoes.appendChild(btnExcluir);

        // Montar cart√£o
        card.appendChild(badge);
        card.appendChild(tituloTarefa);
        card.appendChild(venc);
        card.appendChild(respDiv);
        card.appendChild(progContainer);
        card.appendChild(botoes);
        // Adicionar ao container
        colDiv.appendChild(card);
      });
      // Adiciona a lista ao main
      if(!document.querySelector(`h2:contains("${c.nome}")`)){
        main.appendChild(colDiv);
      }
    });
    // Atualiza alertas de tarefas atrasadas
    atualizarDashboard();
  }

  // Criar nova tarefa
  function criarTarefa() {
    const listaID = prompt('ID da lista onde criar a tarefa (deixe vazio para lista padr√£o):');
    let lista = null;
    if (listaID) {
      lista = colunas.find(c => c.id == listaID);
      if (!lista) { alert('Lista n√£o encontrada'); return; }
    } else {
      if(colunas.length===0){ alert('Nenhuma lista criada'); return; }
      lista = colunas[0];
    }
    const texto = prompt('Descri√ß√£o da tarefa:', 'Nova tarefa');
    if (!texto) return;
    lista.tarefas.push({
      id: Date.now(),
      texto,
      prioridade: 'Baixo',
      responsavel: '',
      vencimento: '',
      progresso: 0,
      comentarios: []
    });
    salvarEstado();
    renderizarTarefas();
  }

  // Coment√°rios
  function abrirComentarios(tarefa) {
    tarefaAtualComentando = tarefa;
    document.getElementById('comentariosList').innerHTML='';
    (tarefa.comentarios || []).forEach(c => {
      const div = document.createElement('div');
      div.className='comentario';
      div.innerHTML=`<b>${c.autor}</b> (${c.data}):<br/>${c.comentario}`;
      document.getElementById('comentariosList').appendChild(div);
    });
    document.getElementById('novoComentario').value='';
    document.getElementById('modalComentario').style.display='block';
  }
  function salvarComentario() {
    const c = {
      autor: prompt('Seu nome:', 'Usu√°rio') || 'Anonimo',
      comentario: document.getElementById('novoComentario').value,
      data: new Date().toLocaleString()
    };
    tarefaAtualComentando.comentarios = tarefaAtualComentando.comentarios || [];
    tarefaAtualComentando.comentarios.push(c);
    salvarEstado();
    abrirComentarios(tarefaAtualComentando);
  }
  function fecharComentario() {
    document.getElementById('modalComentario').style.display='none';
  }

  // Mostrar painel de an√°lise
  function mostrarAnalise() {
    document.getElementById('painelAnalise').style.display='block';
    gerarDashboard();
  }
  function fecharAnalise() {
    document.getElementById('painelAnalise').style.display='none';
  }
  function gerarDashboard() {
    const dash = document.getElementById('dashboard');
    dash.innerHTML='';
    const total = colunas.reduce((ac, c) => ac + c.tarefas.length,0);
    const concluidas = colunas.reduce((ac, c) => ac + c.tarefas.filter(t=>t.progresso>=100).length,0);
    const atrasadas = colunas.reduce((ac, c) => ac + c.tarefas.filter(t => t.vencimento && new Date(t.vencimento) < new Date() && t.progresso<100).length,0);
    const porPrioridade = { Alto:0, Medio:0, Baixo:0 };
    const porResponsavel = {};
    colunas.forEach(c => {
      c.tarefas.forEach(t => {
        if(porPrioridade[t.prioridade]) porPrioridade[t.prioridade]++;
        if(t.responsavel) {
          porResponsavel[t.responsavel] = (porResponsavel[t.responsavel]||0)+1;
        }
      });
    });
    dash.innerHTML=`
      <p>Total de tarefas: ${total}</p>
      <p>Conclu√≠das: ${concluidas}</p>
      <p>Atrasadas: ${atrasadas}</p>
      <h3>Por Prioridade</h3>
      <ul>
        <li>Alto: ${porPrioridade.Alto || 0}</li>
        <li>M√©dio: ${porPrioridade.Medio || 0}</li>
        <li>Baixo: ${porPrioridade.Baixo || 0}</li>
      </ul>
      <h3>Por Respons√°vel</h3>
      <ul>
        ${Object.entries(porResponsavel).map(([resp,count]) => `<li>${resp}: ${count}</li>`).join('')}
      </ul>
    `;
  }

  // Limpar tudo
  function limparTudo() {
    if(confirm('Deseja apagar tudo?')){
      colunas = [];
      salvarEstado();
      renderizarTarefas();
    }
  }

  // Atualizar alertas de tarefas atrasadas
  function atualizarDashboard() {
    const atrasadas = [];
    colunas.forEach(c => {
      c.tarefas.forEach(t => {
        if(t.vencimento && new Date(t.vencimento) < new Date() && t.progresso < 100) {
          atrasadas.push(t);
        }
      });
    });
    const alerta = document.getElementById('alertaAtrasadas');
    if (atrasadas.length > 0) {
      alerta.innerHTML = `Tarefas atrasadas: ${atrasadas.length}. Clique aqui para ver detalhes.`;
      alerta.classList.add('show');
    } else {
      alerta.classList.remove('show');
    }
  }

  // Evento click na notifica√ß√£o
  document.getElementById('alertaAtrasadas').onclick = () => {
    const atrasadas = [];
    colunas.forEach(c => {
      c.tarefas.forEach(t => {
        if(t.vencimento && new Date(t.vencimento) < new Date() && t.progresso < 100) {
          atrasadas.push(t);
        }
      });
    });
    alert('Tarefas atrasadas:\n' + atrasadas.map(t => t.texto).join('\n'));
  }

  // Buscar tarefas
  function filtrarConteudo() {
    const termo = document.getElementById('searchInput').value.toLowerCase();
    document.querySelectorAll('.cartao').forEach(c => {
      const texto = c.querySelector('.titulo').textContent.toLowerCase();
      c.style.display = texto.includes(termo) ? '' : 'none';
    });
  }

  // Inicializar app
  function init() {
    carregarDadosLocal();
    aplicarTema();
    renderizarTarefas();
    setInterval(atualizarDashboard, 60000); // verifica a cada minuto
    atualizarDashboard(); // primeira verifica√ß√£o
  }

  // Eventos globais
  window.onload=init;
</script>

</body>
</html>
