<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FJNOTES - Gerenciador Visual</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');
  * { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Montserrat', sans-serif;
  background-color: #121212;
  color: #FFC107;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  overflow-x: hidden;
}
header {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  justify-content: space-between;
  padding: 1rem 2rem;
  position: sticky;
  top: 0;
  background-color: inherit;
  border-bottom: 2px solid currentColor;
  z-index: 999;
}
h1 { font-weight: 700; font-size: 1.8rem; margin-right: 1rem; }
#searchInput {
  padding: 0.4rem 0.8rem;
  border-radius: 12px;
  border: none;
  background-color: #222;
  color: #ffc107;
  font-size: 1rem;
  outline: none;
  min-width: 200px;
  margin: 0.5rem 0;
}
body.light #searchInput {
  background-color: #eee8d5;
  color: #b58900;
}
#botoes {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 0.5rem;
}
button {
  padding: 0.4rem 0.8rem;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 700;
  font-size: 0.85rem;
  transition: background 0.3s;
}
button:hover { opacity: 0.8; }

#toast {
  position: fixed; bottom: 1.5rem; right: 1.5rem;
  background: #ffc107dd; padding: 1rem; border-radius: 8px; font-weight: 700; font-family: 'Montserrat', sans-serif;
  box-shadow: 0 0 15px #ffc107aa; opacity: 0; transition: opacity 0.3s ease; z-index: 9999;
}
#toast.show { opacity: 1; }

main {
  flex: 1;
  padding: 1rem 2rem;
  display: flex;
  gap: 1rem;
  overflow-x: auto;
  align-items: flex-start;
}

/* Colunas (listas) */
.coluna {
  background-color: #222;
  padding: 1rem;
  border-radius: 12px;
  min-width: 250px;
  display: flex;
  flex-direction: column;
  max-height: 90vh;
}
.coluna h2 {
  margin-bottom: 0.5rem;
  font-weight: 700;
  font-size: 1.2rem;
  color:#ffd700;
}
#btnAddCol { margin-bottom: 1rem; }

.tarefa {
  background: #fff8dc;
  border-radius: 12px;
  padding: 0.5rem;
  margin-bottom: 0.8rem;
  cursor: grab;
  border: 2px solid currentColor;
  display: flex;
  flex-direction: column;
  transition: box-shadow 0.2s;
}
.tarefa:hover { box-shadow: 0 0 10px #ffd700; }
.titulo {
  font-weight: 900; font-size: 1rem; margin-bottom: 0.3rem; cursor: text;
}
.titulo:focus { outline: 2px solid #ffd700; }
.progress-container {
  background: #ddd; height: 8px; border-radius: 4px; margin: 8px 0;
  width: 100%;
}
.progress-bar {
  height: 8px; background: #ffc107; width: 0%; border-radius: 4px;
  transition: width 0.5s ease;
}
.badge-pri {
  padding: 0.2rem 0.5rem;
  border-radius: 8px;
  font-size: 0.75rem;
  font-weight: bold;
  color: #fff;
  display: inline-block;
  min-width: 50px;
  text-align: center;
  margin-bottom: 0.5rem;
}
.prio-alto { background-color: #d32f2f; }
.prio-medio { background-color: #fbc02d; color:#000; }
.prio-baixo { background-color: #388e3c; }

.botoes-acao {
  display: flex; gap: 4px; margin-top: 0.5rem; flex-wrap: wrap;
}
button {
  padding: 0.3rem 0.6rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 0.75rem;
}
.btnExcluir { background: #d32f2f; color: #fff; }
.btnEditar { background: #1976d2; color: #fff; }
.btnPrioridade { background: #fbc02d; color:#000; }
.btnProgresso { background: #388e3c; color:#fff; }

#alertaAtrasadas {
  position: fixed;
  top: 10px;
  right: 10px;
  background: #d32f2f;
  color: #fff;
  padding: 1rem;
  border-radius: 8px;
  font-weight: bold;
  display: none;
  cursor: pointer;
  z-index: 10000;
  box-shadow: 0 0 10px #d32f2f;
  transition: opacity 0.3s ease;
}
#alertaAtrasadas.show {
  display: block;
  opacity: 1;
}
</style>
</head>
<body>

<!-- Notifica√ß√£o de tarefas atrasadas -->
<div id="alertaAtrasadas"></div>

<header>
  <h1>FJNOTES - Gerenciador Visual</h1>
  <input type="search" id="searchInput" placeholder="Buscar..." oninput="filtrarConteudo()" />
  <div id="botoes">
    <button onclick="undoEstado()" id="btnUndo" disabled title="Desfazer">‚Ü∂ Undo</button>
    <button onclick="redoEstado()" id="btnRedo" disabled title="Refazer">‚Ü∑ Redo</button>
    <button onclick="toggleTema()" title="Alternar tema">üåì Tema</button>
    <button onclick="adicionarColuna()" id="btnAddCol">Adicionar Coluna</button>
  </div>
</header>

<main id="board">
  <!-- colunas ser√£o criadas dinamicamente aqui -->
</main>

<div style="margin:1rem; text-align:center;">
  <button onclick="criarTarefa()">Nova Tarefa</button>
  <button onclick="limparTudo()">Limpar Tudo</button>
  <button onclick="mostrarAnalise()">Painel de An√°lise</button>
</div>

<!-- Painel de an√°lise -->
<div id="painelAnalise" style="display:none; position:fixed; top:10%; left:10%; width:80%; height:80%; background:#fff; padding:1rem; overflow:auto; z-index:10000; border-radius:8px;">
  <h2>An√°lise de Tarefas</h2>
  <button style="float:right;" onclick="fecharAnalise()">Fechar</button>
  <div id="dashboard"></div>
</div>

<!-- Modal coment√°rios -->
<div id="modalComentario" style="display:none; position:fixed; top:20%; left:20%; width:60%; height:40%; background:#fff; padding:1rem; overflow:auto; z-index:10000; border-radius:8px;">
  <h3>Coment√°rios</h3>
  <div id="comentariosList"></div>
  <textarea id="novoComentario" style="width:100%; height:3rem; margin-top:0.5rem;" placeholder="Adicionar coment√°rio"></textarea>
  <button onclick="salvarComentario()">Salvar Coment√°rio</button>
  <button onclick="fecharComentario()">Fechar</button>
</div>

<script>
  let colunas = [];
  let tarefas = [];
  let historico = [];
  let indexHistorico = -1;
  const MAX_HIST = 50;
  let tarefaEmEdicao = null;
  let tarefaAtualComentando = null;

  // Fun√ß√£o de toast
  function toast(msg) {
    const t = document.getElementById('toast');
    if (!t) {
      const newT = document.createElement('div');
      newT.id='toast';
      document.body.appendChild(newT);
    }
    document.getElementById('toast').textContent=msg;
    document.getElementById('toast').classList.add('show');
    setTimeout(()=>{ document.getElementById('toast').classList.remove('show'); }, 3000);
  }

  // Carregar do localStorage
  function salvarEstado() {
    if (indexHistorico < historico.length -1) {
      historico.splice(indexHistorico+1);
    }
    const snap = JSON.stringify({ colunas });
    historico.push(snap);
    if (historico.length > MAX_HIST) {
      historico.shift();
      if (indexHistorico > 0) indexHistorico--;
    } else {
      indexHistorico++;
    }
    atualizarBotoesUndoRedo();
    salvarDadosLocal();
  }
  function carregarEstado() {
    if (indexHistorico >= 0 && indexHistorico < historico.length) {
      try {
        const snap = JSON.parse(historico[indexHistorico]);
        colunas = snap.colunas || [];
        renderizarBoard();
        atualizarBotoesUndoRedo();
        atualizarDashboard();
      } catch {
        toast('Erro ao restaurar');
      }
    }
  }
  function undoEstado() {
    if (indexHistorico > 0) {
      indexHistorico--;
      carregarEstado();
    }
  }
  function redoEstado() {
    if (indexHistorico < historico.length - 1) {
      indexHistorico++;
      carregarEstado();
    }
  }
  function atualizarBotoesUndoRedo() {
    document.getElementById('btnUndo').disabled = indexHistorico <= 0;
    document.getElementById('btnRedo').disabled = indexHistorico >= historico.length -1;
  }

  // Tema
  function toggleTema() {
    document.body.classList.toggle('dark');
    document.body.classList.toggle('light');
    localStorage.setItem('tema', document.body.classList.contains('dark') ? 'dark' : 'light');
  }
  function aplicarTema() {
    const t = localStorage.getItem('tema') || 'dark';
    document.body.classList.toggle('dark', t==='dark');
    document.body.classList.toggle('light', t==='light');
  }

  // Persistir dados
  function salvarDadosLocal() {
    localStorage.setItem('tarefasData', JSON.stringify({ colunas }));
  }
  function carregarDadosLocal() {
    const dados = localStorage.getItem('tarefasData');
    if (dados) {
      try {
        const obj = JSON.parse(dados);
        colunas = obj.colunas || [];
      } catch {
        colunas = [];
      }
    }
  }

  // Adicionar coluna
  function adicionarColuna() {
    const nome = prompt('Nome da coluna:', 'Nova Lista');
    if (!nome) return;
    const novaCol = {
      id: Date.now(),
      nome,
      tarefas: []
    };
    colunas.push(novaCol);
    salvarEstado();
    renderizarBoard();
  }

  // Criar nova tarefa
  function criarTarefa() {
    if (colunas.length===0) {
      alert('Crie uma coluna primeiro.');
      return;
    }
    const listaID = prompt('ID da lista (deixe vazio para a primeira):');
    let lista = null;
    if (listaID) {
      lista = colunas.find(c=>c.id==listaID);
      if (!lista) { alert('Lista n√£o encontrada'); return; }
    } else {
      lista = colunas[0];
    }
    const texto = prompt('Descri√ß√£o da tarefa:', 'Nova tarefa');
    if (!texto) return;
    lista.tarefas.push({
      id: Date.now(),
      texto,
      prioridade: 'Baixo',
      responsavel: '',
      vencimento: '',
      progresso: 0,
      comentarios: []
    });
    salvarEstado();
    renderizarBoard();
  }

  // Renderizar board
  function renderizarBoard() {
    const container = document.getElementById('board');
    container.innerHTML='';
    colunas.forEach(c => {
      const colDiv = document.createElement('div');
      colDiv.className='coluna';

      // Cabe√ßalho
      const headerCol = document.createElement('div');
      headerCol.style.display='flex'; headerCol.style.justifyContent='space-between'; alignItems='center';
      const tituloCol = document.createElement('h2');
      tituloCol.textContent = c.nome;
      const btnRenomear = document.createElement('button');
      btnRenomear.textContent='‚úé';
      btnRenomear.title='Renomear coluna';
      btnRenomear.onclick= ()=> {
        const novoNome = prompt('Novo nome:', c.nome);
        if(novoNome) { c.nome=novoNome; salvarEstado(); renderizarBoard(); }
      };
      const btnRemover = document.createElement('button');
      btnRemover.textContent='üóëÔ∏è';
      btnRemover.title='Remover coluna';
      btnRemover.onclick= ()=> {
        if(confirm('Remover coluna?')){
          colunas = colunas.filter(cc=>cc.id!==c.id);
          salvarEstado();
          renderizarBoard();
        }
      };
      headerCol.appendChild(tituloCol);
      headerCol.appendChild(btnRenomear);
      headerCol.appendChild(btnRemover);
      colDiv.appendChild(headerCol);

      // Bot√£o adicionar tarefa
      const btnAddTarefa = document.createElement('button');
      btnAddTarefa.textContent='Adicionar Tarefa';
      btnAddTarefa.onclick= ()=> {
        const texto = prompt('Descri√ß√£o da tarefa:', 'Nova tarefa');
        if (!texto) return;
        c.tarefas.push({
          id: Date.now(),
          texto,
          prioridade: 'Baixo',
          responsavel: '',
          vencimento: '',
          progresso: 0,
          comentarios: []
        });
        salvarEstado();
        renderizarBoard();
      };
      colDiv.appendChild(btnAddTarefa);

      // Tarefas
      c.tarefas.forEach((t,i) => {
        const card = document.createElement('div');
        card.className='tarefa';
        card.draggable=true;
        card.ondragstart= (e)=> {
          e.dataTransfer.setData('text/plain', JSON.stringify({colID:c.id, tarefaID:t.id}));
        };
        card.ondragover= (e)=> { e.preventDefault(); };
        card.ondrop= (e)=> {
          e.preventDefault();
          const data = JSON.parse(e.dataTransfer.getData('text/plain'));
          moverTarefa(data.colID, data.tarefaID, c.id);
        };

        // Badge de prioridade
        let prioClass='';
        if(t.prioridade==='Alto') prioClass='prio-alto';
        if(t.prioridade==='M√©dio') prioClass='prio-medio';
        if(t.prioridade==='Baixo') prioClass='prio-baixo';

        const badge = document.createElement('div');
        badge.className='badge-pri '+prioClass;
        badge.textContent = t.prioridade;
        card.appendChild(badge);

        // T√≠tulo
        const tituloDiv = document.createElement('div');
        tituloDiv.className='titulo';
        tituloDiv.contentEditable=true;
        tituloDiv.textContent=t.texto;
        tituloDiv.onblur= ()=> {
          t.texto= tituloDiv.textContent;
          salvarEstado();
        };
        card.appendChild(tituloDiv);

        // Vencimento
        const vencDiv = document.createElement('div');
        vencDiv.textContent='Vence: '+(t.vencimento||'---');
        if(t.vencimento && new Date(t.vencimento)<new Date()) {
          vencDiv.style.color='red';
        }
        vencDiv.onclick= ()=> {
          const novo = prompt('Data (YYYY-MM-DD):', t.vencimento);
          if(novo!==null) {
            t.vencimento=novo;
            salvarEstado();
            renderizarBoard();
          }
        };
        card.appendChild(vencDiv);

        // Respons√°vel
        const respDiv = document.createElement('div');
        respDiv.textContent='Respons√°vel: '+(t.responsavel||'---');
        respDiv.onclick= ()=> {
          const novo=prompt('Respons√°vel:', t.responsavel);
          if(novo!==null) {
            t.responsavel=novo;
            salvarEstado();
            renderizarBoard();
          }
        };
        card.appendChild(respDiv);

        // Progresso
        const progContainer = document.createElement('div');
        progContainer.className='progress-container';
        const progBar = document.createElement('div');
        progBar.className='progress-bar';
        setTimeout(()=>{ progBar.style.width = t.progresso + '%'; },50);
        progContainer.appendChild(progBar);
        card.appendChild(progContainer);
        // Bot√µes
        const btns = document.createElement('div');
        btns.className='botoes-acao';

        const btnProgresso = document.createElement('button');
        btnProgresso.className='btnProgresso';
        btnProgresso.textContent='Progress +10%';
        btnProgresso.onclick= ()=> {
          t.progresso= Math.min(t.progresso+10, 100);
          salvarEstado();
          renderizarBoard();
        };
        const btnPrioridade = document.createElement('button');
        btnPrioridade.className='btnPrioridade';
        btnPrioridade.textContent='Prioridade';
        btnPrioridade.onclick= ()=> {
          if(t.prioridade==='Baixo') t.prioridade='M√©dio';
          else if(t.prioridade==='M√©dio') t.prioridade='Alto';
          else t.prioridade='Baixo';
          salvarEstado();
          renderizarBoard();
        };
        const btnEditar = document.createElement('button');
        btnEditar.className='btnEditar';
        btnEditar.textContent='‚úé';
        btnEditar.title='Editar descri√ß√£o';
        btnEditar.onclick= ()=> {
          const novoTexto=prompt('Editar descri√ß√£o:', t.texto);
          if(novoTexto!==null) {
            t.texto=novoTexto;
            salvarEstado();
            renderizarBoard();
          }
        };
        const btnComentarios = document.createElement('button');
        btnComentarios.textContent='Coment√°rios';
        btnComentarios.onclick= ()=> { abrirComentarios(t); };
        const btnExcluir = document.createElement('button');
        btnExcluir.className='btnExcluir';
        btnExcluir.textContent='üóëÔ∏è';
        btnExcluir.onclick= ()=> {
          if(confirm('Remover tarefa?')){
            c.tarefas.splice(i,1);
            salvarEstado();
            renderizarBoard();
          }
        };

        [btnProgresso, btnPrioridade, btnEditar, btnComentarios, btnExcluir].forEach(b=>b && btns.appendChild(b));
        card.appendChild(btns);

        c.tarefas[i]=t; // assegura atualiza√ß√£o
        colDiv.appendChild(card);
      });
      container.appendChild(colDiv);
    });
    atualizarDashboard();
  }

  // Mover tarefa entre colunas
  function moverTarefa(origColID, tarefaID, destColID) {
    if (origColID==destColID) return;
    const origem = colunas.find(c=>c.id==origColID);
    const destino= colunas.find(c=>c.id==destColID);
    if(!origem || !destino) return;
    const tIndex= origem.tarefas.findIndex(t=>t.id==tarefaID);
    if(tIndex===-1) return;
    const t= origem.tarefas.splice(tIndex,1)[0];
    destino.tarefas.push(t);
    salvarEstado();
    renderizarBoard();
  }

  // Fun√ß√£o para criar nova coluna
  function criarColuna() {
    const nome=prompt('Nome da nova coluna:', 'Nova Lista');
    if(!nome) return;
    colunas.push({ id: Date.now(), nome, tarefas:[] });
    salvarEstado();
    renderizarBoard();
  }

  // Fun√ß√£o para limpar tudo
  function limparTudo() {
    if(confirm('Deseja apagar tudo?')){
      colunas=[];
      salvarEstado();
      renderizarBoard();
    }
  }

  // Painel de an√°lise
  function mostrarAnalise() {
    document.getElementById('painelAnalise').style.display='block';
    gerarDashboard();
  }
  function fecharAnalise() {
    document.getElementById('painelAnalise').style.display='none';
  }
  function gerarDashboard() {
    const dash= document.getElementById('dashboard');
    dash.innerHTML='';
    const total= colunas.reduce((a,c)=>a+c.tarefas.length,0);
    const concluidas= colunas.reduce((a,c)=>a+c.tarefas.filter(t=>t.progresso>=100).length,0);
    const atrasadas= colunas.reduce((a,c)=>a+c.tarefas.filter(t=>t.vencimento && new Date(t.vencimento)<new Date() && t.progresso<100).length,0);
    const priCount={ Alto:0, Medio:0, Baixo:0 };
    const respCount={};
    colunas.forEach(c => {
      c.tarefas.forEach(t => {
        if(priCount[t.prioridade]) priCount[t.prioridade]++;
        if(t.responsavel) {
          respCount[t.responsavel]= (respCount[t.responsavel]||0)+1;
        }
      });
    });
    dash.innerHTML=`
      <p>Total: ${total}</p>
      <p>Conclu√≠das: ${concluidas}</p>
      <p>Atrasadas: ${atrasadas}</p>
      <h3>Prioridade</h3>
      <ul>
        <li>Alto: ${priCount.Alto ||0}</li>
        <li>M√©dio: ${priCount.Medio ||0}</li>
        <li>Baixo: ${priCount.Baixo ||0}</li>
      </ul>
      <h3>Respons√°veis</h3>
      <ul>
        ${Object.entries(respCount).map(([k,v])=>`<li>${k}: ${v}</li>`).join('')}
      </ul>
    `;
  }

  // Abrir coment√°rios
  function abrirComentarios(tarefa) {
    tarefaAtualComentando= tarefa;
    const listDiv= document.getElementById('comentariosList');
    listDiv.innerHTML='';
    (tarefa.comentarios || []).forEach(c => {
      const div= document.createElement('div');
      div.className='comentario';
      div.innerHTML=`<b>${c.autor}</b> (${c.data}):<br/>${c.comentario}`;
      listDiv.appendChild(div);
    });
    document.getElementById('novoComentario').value='';
    document.getElementById('modalComentario').style.display='block';
  }
  function salvarComentario() {
    const c= {
      autor: prompt('Seu nome:', 'Usu√°rio') || 'Anonimo',
      comentario: document.getElementById('novoComentario').value,
      data: new Date().toLocaleString()
    };
    tarefaAtualComentando.comentarios= tarefaAtualComentando.comentarios || [];
    tarefaAtualComentando.comentarios.push(c);
    salvarEstado();
    abrirComentarios(tarefaAtualComentando);
  }
  function fecharComentario() {
    document.getElementById('modalComentario').style.display='none';
  }

  // Buscar
  function filtrarConteudo() {
    const termo= document.getElementById('searchInput').value.toLowerCase();
    document.querySelectorAll('.tarefa').forEach(t => {
      const texto= t.querySelector('.titulo').textContent.toLowerCase();
      t.style.display= texto.includes(termo)? '' :'none';
    });
  }

  // Inicializar
  function init() {
    carregarDadosLocal();
    aplicarTema();
    renderizarBoard();
    setInterval(atualizarDashboard,60000);
    atualizarDashboard();
  }

  // Atualizar tarefas atrasadas
  function atualizarDashboard() {
    const atrasadas= [];
    colunas.forEach(c => {
      c.tarefas.forEach(t => {
        if(t.vencimento && new Date(t.vencimento)<new Date() && t.progresso<100) {
          atrasadas.push(t);
        }
      });
    });
    const alerta= document.getElementById('alertaAtrasadas');
    if(atrasadas.length>0) {
      alerta.innerHTML= `Tarefas atrasadas: ${atrasadas.length}. Clique aqui`;
      alerta.className='show';
    } else {
      alerta.className='';
    }
  }

  // Evento clique alerta
  document.getElementById('alertaAtrasadas').onclick= ()=> {
    const atrasadas= [];
    colunas.forEach(c => {
      c.tarefas.forEach(t => {
        if(t.vencimento && new Date(t.vencimento)<new Date() && t.progresso<100) {
          atrasadas.push(t);
        }
      });
    });
    alert('Tarefas atrasadas:\n'+atrasadas.map(t=>t.texto).join('\n'));
  };

  window.onload= ()=> {
    init();
    document.getElementById('btnAddCol').onclick= adicionarColuna;
    document.querySelector('button[onclick="criarTarefa()"]').onclick= criarTarefa;
    document.querySelector('button[onclick="limparTudo()"]').onclick= limparTudo;
    document.querySelector('button[onclick="mostrarAnalise()"]').onclick= mostrarAnalise;
  };
</script>

</body>
</html>
