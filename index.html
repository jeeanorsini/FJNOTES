<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FJNOTES Pro - Enhanced</title>
<style>
  /* Existing styles remain the same */
  
  /* New styles for enhanced features */
  .cartao {
    /* Existing styles */
    position: relative;
  }

  .due-date {
    font-size: 0.8rem;
    color: #ffc107;
    margin: 4px 0;
  }

  .priority {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
  }

  .priority-high { background-color: #ff4444; }
  .priority-medium { background-color: #ffbb33; }
  .priority-low { background-color: #00C851; }

  .assignee {
    font-size: 0.8rem;
    color: #ffc107;
    margin: 4px 0;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .comments-section {
    margin-top: 8px;
    border-top: 1px solid #ffc10733;
    padding-top: 8px;
  }

  .comment {
    font-size: 0.8rem;
    margin: 4px 0;
    padding: 4px;
    background: #ffc10711;
    border-radius: 4px;
  }

  .progress-bar {
    height: 4px;
    background: #333;
    border-radius: 2px;
    margin: 4px 0;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: #ffc107;
    transition: width 0.3s ease;
  }

  /* Analytics panel */
  #analyticsPanel {
    position: fixed;
    right: 20px;
    bottom: 20px;
    background: var(--card-bg);
    padding: 1rem;
    border-radius: 12px;
    border: 2px solid currentColor;
    box-shadow: 0 0 15px #ffc10744;
    z-index: 1000;
    display: none;
  }
</style>
</head>
<body class="">
<!-- Existing header remains the same -->

<main>
  <div id="telaPrincipal" aria-label="Quadro de colunas" role="region"></div>
</main>

<div id="botoesBarras" role="toolbar" style="margin:1rem; display:flex; gap:0.5rem; justify-content:center;">
  <button onclick="adicionarColuna()">Adicionar Coluna</button>
  <button onclick="mostrarTabuleiro()">Mostrar Quadro</button>
  <button onclick="toggleAnalytics()">Analytics</button>
  <button onclick="exportarDados()">Exportar Dados</button>
  <button onclick="mostrarImportar()">Importar Dados</button>
  <button onclick="limparTudo()">Limpar Tudo</button>
</div>

<div id="analyticsPanel">
  <h3>Analytics</h3>
  <div id="analyticsContent"></div>
</div>

<input type="file" id="arquivoImportar" style="display:none" onchange="importarDados(event)" />
<div id="toast"></div>

<script>
// Existing variables
let colunas = [];
let modoMapa = false;
let selecao = [];
let historico = [];
let indexHistorico = -1;
const MAX_HIST = 50;

// Enhanced card structure
function createNewCard(texto) {
  return {
    id: Date.now(),
    texto: texto,
    tags: [],
    dueDate: null,
    priority: 'medium',
    assignee: null,
    comments: [],
    progress: 0,
    createdAt: new Date().toISOString()
  };
}

// Enhanced renderizaÃ§Ã£o de cartÃµes
function renderizarCartao(cartao, colDiv, col, i) {
  const cartaoDiv = document.createElement('div');
  cartaoDiv.className = 'cartao';
  cartaoDiv.setAttribute('data-colid', col.id);
  cartaoDiv.setAttribute('data-index', i);
  cartaoDiv.draggable = true;
  
  // Priority indicator
  const priorityDot = document.createElement('div');
  priorityDot.className = `priority priority-${cartao.priority || 'medium'}`;
  cartaoDiv.appendChild(priorityDot);

  // Text area
  const ta = document.createElement('textarea');
  ta.value = cartao.texto;
  ta.oninput = () => {
    cartao.texto = ta.value;
    salvarEstado();
  };
  cartaoDiv.appendChild(ta);

  // Due date
  if (cartao.dueDate) {
    const dueDate = document.createElement('div');
    dueDate.className = 'due-date';
    dueDate.textContent = `Due: ${new Date(cartao.dueDate).toLocaleDateString()}`;
    cartaoDiv.appendChild(dueDate);
  }

  // Progress bar
  const progressBar = document.createElement('div');
  progressBar.className = 'progress-bar';
  const progressFill = document.createElement('div');
  progressFill.className = 'progress-fill';
  progressFill.style.width = `${cartao.progress || 0}%`;
  progressBar.appendChild(progressFill);
  cartaoDiv.appendChild(progressBar);

  // Assignee
  if (cartao.assignee) {
    const assignee = document.createElement('div');
    assignee.className = 'assignee';
    assignee.textContent = `ðŸ‘¤ ${cartao.assignee}`;
    cartaoDiv.appendChild(assignee);
  }

  // Comments section
  if (cartao.comments && cartao.comments.length > 0) {
    const commentsSection = document.createElement('div');
    commentsSection.className = 'comments-section';
    cartao.comments.forEach(comment => {
      const commentDiv = document.createElement('div');
      commentDiv.className = 'comment';
      commentDiv.textContent = comment;
      commentsSection.appendChild(commentDiv);
    });
    cartaoDiv.appendChild(commentsSection);
  }

  // Action buttons
  const actionButtons = document.createElement('div');
  actionButtons.style.display = 'flex';
  actionButtons.style.gap = '4px';
  actionButtons.style.marginTop = '8px';

  // Add due date button
  const btnDueDate = document.createElement('button');
  btnDueDate.textContent = 'ðŸ“…';
  btnDueDate.title = 'Set due date';
  btnDueDate.onclick = e => {
    e.stopPropagation();
    const date = prompt('Enter due date (YYYY-MM-DD):', 
      cartao.dueDate ? new Date(cartao.dueDate).toISOString().split('T')[0] : '');
    if (date) {
      cartao.dueDate = new Date(date).toISOString();
      salvarEstado();
      renderizarColunas();
    }
  };
  actionButtons.appendChild(btnDueDate);

  // Add priority button
  const btnPriority = document.createElement('button');
  btnPriority.textContent = 'ðŸŽ¯';
  btnPriority.title = 'Set priority';
  btnPriority.onclick = e => {
    e.stopPropagation();
    const priority = prompt('Set priority (high/medium/low):', cartao.priority || 'medium');
    if (priority && ['high', 'medium', 'low'].includes(priority.toLowerCase())) {
      cartao.priority = priority.toLowerCase();
      salvarEstado();
      renderizarColunas();
    }
  };
  actionButtons.appendChild(btnPriority);

  // Add assignee button
  const btnAssignee = document.createElement('button');
  btnAssignee.textContent = 'ðŸ‘¤';
  btnAssignee.title = 'Assign to';
  btnAssignee.onclick = e => {
    e.stopPropagation();
    const assignee = prompt('Assign to:', cartao.assignee || '');
    if (assignee) {
      cartao.assignee = assignee;
      salvarEstado();
      renderizarColunas();
    }
  };
  actionButtons.appendChild(btnAssignee);

  // Add comment button
  const btnComment = document.createElement('button');
  btnComment.textContent = 'ðŸ’¬';
  btnComment.title = 'Add comment';
  btnComment.onclick = e => {
    e.stopPropagation();
    const comment = prompt('Add comment:');
    if (comment) {
      if (!cartao.comments) cartao.comments = [];
      cartao.comments.push(comment);
      salvarEstado();
      renderizarColunas();
    }
  };
  actionButtons.appendChild(btnComment);

  // Progress button
  const btnProgress = document.createElement('button');
  btnProgress.textContent = 'ðŸ“Š';
  btnProgress.title = 'Update progress';
  btnProgress.onclick = e => {
    e.stopPropagation();
    const progress = prompt('Enter progress (0-100):', cartao.progress || '0');
    if (progress !== null && !isNaN(progress) && progress >= 0 && progress <= 100) {
      cartao.progress = Number(progress);
      salvarEstado();
      renderizarColunas();
    }
  };
  actionButtons.appendChild(btnProgress);

  cartaoDiv.appendChild(actionButtons);
  return cartaoDiv;
}

// Analytics functions
function toggleAnalytics() {
  const panel = document.getElementById('analyticsPanel');
  if (panel.style.display === 'none') {
    updateAnalytics();
    panel.style.display = 'block';
  } else {
    panel.style.display = 'none';
  }
}

function updateAnalytics() {
  const analytics = {
    totalTasks: 0,
    completedTasks: 0,
    overdueTasks: 0,
    tasksByPriority: { high: 0, medium: 0, low: 0 },
    tasksByAssignee: {}
  };

  colunas.forEach(col => {
    col.cartoes.forEach(card => {
      analytics.totalTasks++;
      if (card.progress === 100) analytics.completedTasks++;
      if (card.dueDate && new Date(card.dueDate) < new Date()) analytics.overdueTasks++;
      if (card.priority) analytics.tasksByPriority[card.priority]++;
      if (card.assignee) {
        analytics.tasksByAssignee[card.assignee] = 
          (analytics.tasksByAssignee[card.assignee] || 0) + 1;
      }
    });
  });

  const content = document.getElementById('analyticsContent');
  content.innerHTML = `
    <p>Total Tasks: ${analytics.totalTasks}</p>
    <p>Completed Tasks: ${analytics.completedTasks}</p>
    <p>Overdue Tasks: ${analytics.overdueTasks}</p>
    <h4>Tasks by Priority:</h4>
    <p>High: ${analytics.tasksByPriority.high}</p>
    <p>Medium: ${analytics.tasksByPriority.medium}</p>
    <p>Low: ${analytics.tasksByPriority.low}</p>
    <h4>Tasks by Assignee:</h4>
    ${Object.entries(analytics.tasksByAssignee)
      .map(([assignee, count]) => `<p>${assignee}: ${count}</p>`)
      .join('')}
  `;
}

// Modify existing renderizarColunas to use the new renderizarCartao function
function renderizarColunas() {
  const container = document.getElementById('telaPrincipal');
  container.innerHTML = '';
  
  colunas.forEach(col => {
    const colDiv = document.createElement('div');
    colDiv.className = 'coluna';
    colDiv.setAttribute('data-id', col.id);
    
    const h2 = document.createElement('h2');
    h2.textContent = col.nome;
    colDiv.appendChild(h2);
    
    const btnAddCard = document.createElement('button');
    btnAddCard.className = 'btn-primary';
    btnAddCard.textContent = 'Adicionar CartÃ£o';
    btnAddCard.onclick = () => {
      const texto = prompt('ConteÃºdo do cartÃ£o:', '');
      if(!texto) return;
      col.cartoes.push(createNewCard(texto));
      salvarEstado();
      renderizarColunas();
    };
    colDiv.appendChild(btnAddCard);
    
    col.cartoes.forEach((cartao, i) => {
      const cartaoDiv = renderizarCartao(cartao, colDiv, col, i);
      colDiv.appendChild(cartaoDiv);
    });
    
    // Drag & Drop handlers remain the same
    colDiv.ondragover = e => e.preventDefault();
    colDiv.ondrop = e => {
      const data = JSON.parse(e.dataTransfer.getData('cartao'));
      const origCol = colunas.find(c => c.id === data.colId);
      if(origCol) {
        const cartao = origCol.cartoes.splice(data.index,1)[0];
        col.cartoes.push(cartao);
        salvarEstado();
        renderizarColunas();
      }
    };
    
    container.appendChild(colDiv);
  });
}

// Initialize
renderizarColunas();
mostrarTabuleiro();
salvarEstado();
</script>
</body>
</html>
